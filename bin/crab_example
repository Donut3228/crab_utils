#!/bin/bash

set -eu
__SILENT=TRUE
. /opt/crab/crab_utils/bin/::carbon.sys

sys::usage "$@"
### --help утилита поиска примеров http://www.opencarbon.ru и можно свои добавлять списки
### --help Usage:
### --help crab_example sed  - примеры sed
### --help crab_example bash string - примеры bash подпримеры работы со строками
### --help crab_example update - обновить кеш всех списков



if [ "${1}" == update ]; then

	echo 0 > /tmp/.carbon_example/lastupdate
fi

update(){
	wget http://opencarbon.ru/example:example_index -O /tmp/example_index.$$ &>/dev/null
	example_pages=$( grep href /tmp/example_index.$$ | grep example:example \
		| grep 'class="wikilink1"' | grep -v start \
		| grep -v example_index | sed -n 's/.*href="\/\([^"]*\).*/\1/p' )
	rm -f /tmp/example_index.$$
	for page in $example_pages; do
		echo "http://www.opencarbon.ru/?do=export_raw&id=${page}"
	done > "$HOME/.carbon_example.urls"
	touch "$HOME/.carbon_example_custom.urls"
	rm -f /tmp/.carbon_example/*
	for url in $(<$HOME/.carbon_example.urls) $(<$HOME/.carbon_example_custom.urls); do
		wget $url -O - 2>/dev/null \
			| grep -v '^<code ' | grep -v '^</code>' > /tmp/.carbon_example/${url//\//_}
	done
	date +%s > /tmp/.carbon_example/lastupdate
	return 0
}

mkdir -p /tmp/.carbon_example
touch /tmp/.carbon_example/lastupdate

if [ "${1}" == update ]; then
	update
fi

if [ $((`date +%s`-$(</tmp/.carbon_example/lastupdate) + 0 )) -gt $((3600*24)) ]; then
	update
fi

>/tmp/crab_example.$$

for url in $(<$HOME/.carbon_example.urls) $(<$HOME/.carbon_example_custom.urls); do
	grep -i -A 1 "###$1" /tmp/.carbon_example/${url//\//_} \
		| grep -i -A 1 "${2:-.}" >>/tmp/crab_example.$$ || true
	if [ $(cat /tmp/crab_example.$$ | wc -l ) = 0 ]; then
		grep -i -B 1 -A 1 "$1" /tmp/.carbon_example/${url//\//_} \
			| grep -i -A 1 "${2:-.}" >>/tmp/crab_example.$$ || true
		:
	fi
done
cat /tmp/crab_example.$$ | grep -v '^--$' \
	| while read -r line; do
		if [ "${line:0:1}" = '#' ]; then
			if [ "${line:0:3}" = '###' ]; then
				echo -e "${line}"
			else
				echo -e "${line%%###*}"
			fi
		else
			echo -e "${line}"
			echo
		fi
	done || true
rm -f /tmp/crab_example.$$
exit 0
