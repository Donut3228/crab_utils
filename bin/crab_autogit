#!/bin/bash

set -euEo pipefail
echo "$0 $@ [$$] START" >&2


usage(){
	echo "Usage: $0 install \$DIR [origin]"
	echo "Usage: $0 save \$DIR [user_commit_message]"
	echo
	echo "Example: $0 install \$DIR  # install for newdir"
	echo "Example: $0 install \$DIR git@gitlab.example.com:autogit/\$myhostname"
	echo "Example: $0 install \$DIR root@example.com:/home/autogit/\$myhostname_\$dir"
	echo "Example: $0 save \$DIR \"Fix config\"  # once add, commit, push"
	echo
	echo "Info: Утилита добавляет в .git все файлы, в том числе вложенные в другие git каталоги"
	echo "и автоматически раз в день коммитит и, если указано, отправляет на сервер"
	echo "Автоматом добавляет задачу cron.d '01 07 * * * * root $0 \$DIR'"
	echo "if you install \$dir=/ then .gitignore=/*,!/etc"
	echo "you can edit \$DIR/.gitignore to customize."
	exit 0
}


[ "${1:---help}" = "--help" ] && usage

ARGV="$@"


__exit(){
	local ret=$1
	[ "$ret" = 0 ] && echo "$0 $ARGV [$$] SUCCESS" >&2 \
		|| echo "$0 $ARGV [$$] FAILED" >&2
	exit $ret
}


__git_safe_add() {
	# Добавим вначале файлы из всех вложенных суб-гитов, чтобы избежать их добавления как суб_модулей.
	# Затем добавим саму запрашиваемую папку.
	local dir="$1"
	local git_dir

	for git_dir in $(find $dir -depth -mindepth 2 -type d -name .git | sed 's/git$//'); do
		# -depth - чтобы вначале добавлялись самые глубокие папки. Если есть вложенности.
		# git_dir == some_dir_with_.git/.
		git add --all "$git_dir"
	done
	git add --all $dir/.
	return 0
}


autogit_sync() {
	local current_branch sub_dir
	cd "$ARG_DIR"

	[ ! -d ".git" ] && __init_dir
	__git_config_set

	if [ -f .gitignore ] && egrep -xqm1 '/?\*' .gitignore; then
		# Небольшая оптимизация, когда много исключений
		# Не будем ходить в папки, которые в игнор или без изменений.
		for sub_dir in $(find -mindepth 1 -maxdepth 1 -type d); do
			if ! git status "$sub_dir" | grep -qm1 "nothing to commit"; then
				__git_safe_add "$sub_dir"
			fi
		done
		git add --all .
	else
		__git_safe_add .
	fi

	if ! git status | grep -qm1 'nothing to commit'; then
		git commit -F - <<EOF
$0 $ARG_DIR ${USER_MSG:-}
$( git status -s | head -n 100 || true )
...
EOF
	fi

	git gc
	if git remote | grep -xqm1 origin; then
		current_branch="$(git rev-parse --abbrev-ref HEAD)"
		git push origin "$current_branch:$current_branch"
	fi
	return 0
}


__git_config_set(){
	cd "$ARG_DIR"
	if ! myip="$( ip r g 1 | grep src | sed 's/.*src //' )"; then
		myip="$(hostname)"
	fi
	git config user.email "root@$myip"
	git config user.name "crab_autogit"
	return 0
}


__init_dir(){
	cd "$ARG_DIR"
	[ ! -d ".git" ] && git init
	__git_config_set
	if [ "$ARG_DIR" = "/" ] && [ ! -f ".gitignore" ]; then
		cat > .gitignore <<EOF
/*
!/.gitignore
!/etc
EOF
	fi
	if [ -f ".gitignore" ]; then
		git add .gitignore
	fi
	if ! git status | grep 'nothing to commit'; then
		git commit -m init --allow-empty
	fi
	return 0
}


__ssh_repo_init(){
	local _
	local rdir=${ARG_ORIGIN##*:}

	rhost="${ARG_ORIGIN%%:*}"
	[[ "$rhost" != *@* ]] && rhost="root@$rhost"
	if [ ! -f /root/.ssh/id_rsa ]; then
		ssh-keygen -t rsa -N '' -f /root/.ssh/id_rsa
	fi
	if ! ssh -oBatchMode=yes -oStrictHostKeyChecking=no "$rhost" exit 0; then
		if ! read -r -p "plz type enter for manual type ssh password(enter):" -t 10; then
			echo -e "\nTimeout. Exit."
			__exit 1
		fi
		cat /root/.ssh/id_rsa.pub | ssh "$rhost" "cat >> ~/.ssh/authorized_keys"
	fi
	if ! ssh "$rhost" test -f "$rdir/HEAD"; then
		ssh "$rhost"  git init --bare "$rdir"
	fi
	return 0
}


__cron_init(){
	# настроим cron на раз в день
	local cron_name=crab_autogit${ARG_DIR//\//_}
	cat > /etc/cron.d/$cron_name <<EOF
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/root
01 07 * * * * root /opt/crab/crab_utils/bin/crab_autogit save "${ARG_DIR}" \
  &>> /var/log/${cron_name}.log
EOF
	if [ -x /etc/init.d/crond ]; then
		/etc/init.d/crond restart
	elif [ -x /etc/init.d/cron ]; then
		/etc/init.d/cron restart
	elif chkconfig --list crond &>/dev/null; then
		service crond restart
	else
		echo "Cron init script not found, pls, restart cron manually."
	fi
	return 0
}


autogit_install(){
	cd "$ARG_DIR"
	[[ "${ARG_ORIGIN:-}" == *:/*  ]] && __ssh_repo_init
	__init_dir
	if [ -n "${ARG_ORIGIN}" ] \
		&& ! git remote | grep -xqm1 origin; then
		git remote add origin "${ARG_ORIGIN}"
	fi
	autogit_sync
	__cron_init
	autogit_sync
	return 0
}


check_and_set_dir() {
	local dir="$1"
	if ! [ -d "$dir" ] || ! [[ $dir == /* ]]; then
		echo "Error! You must pass absolute path to git dir!" >&2
		usage
		return 1
	fi
	ARG_DIR="$dir"
	return 0
}


if [ "${1:-}" = "save" ]; then
	check_and_set_dir "${2:-}"
	if [ -n "${3:-}" ]; then
		USER_MSG="$3"
	fi
	autogit_sync

elif [ "${1:-}" = "install" ]; then
	check_and_set_dir "${2:-}"
	ARG_ORIGIN="${3:-}"
	autogit_install

# Для совместимости со старыми версиями, $0 /dir - эквивалентно $0 save /dir
elif [ ! -z "${1:-}" -a -d "${1:-}" ]; then
	check_and_set_dir "${1:-}"
	if [ -n "${2:-}" ]; then
		USER_MSG="$2"
	fi
	autogit_sync

else
	echo -e "\nUnknown command: ${1:-}\n"
	usage
	exit 1
fi


echo "$0 $@ [$$] SUCCESS" >&2
exit 0
